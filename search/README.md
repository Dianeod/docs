Custom search engine for code.kx.com
====================================

The configuration file `mkdocs.yml` unplugs the native search engine. 

<details>
<summary>Why we wrote a custom search engine</summary>

The native search engine is based on [Lunr.js](http://lunrjs.com), a client-side search of the website content. 
Our site is served over the Web, so there is a **noticeable delay** the first time the Search box is used, 
while it retrieves a 2Mb index file.

We have no control over the **deadword list**, so queries on _and_ and _$_ return no results. 

The native engine gives insufficient priority to where a search term appears as a **heading**. 

Results are displayed as a **popup list**. 
The very large majority of code.kx.com visitors use desktop or laptops, where a page of results is more useful.

</details>

The script `docs/scripts/theme.js` restores the HTML previously generated for the Search box. 
A query from the Search box for `xxx` is sent to the server as `/search?query=xxx`. 

The Apache server acts as a [reverse proxy][3] and directs the query to the Searcher. 


Searcher
--------

The Searcher is a kdb+ process run by user `indy` as a daemon under [`systemd`][5], as specified by `/etc/systemd/system/kxsearch.service`.
This service runs `srchr.q`.

It listens on 127.0.0.1:5022 – i.e. will accept internal connections only. 

The search engine loads the index tables on launch. 
The index tables are in `/home/indy/data`. 
User `indy` has read-only access to `/home/indy/data`. 

The engine logs every request by passing it in an async call over a Unix connection to the Logger.


Logger
------

The Logger is a kdb+ process run by user `logger` as a daemon under [`systemd`][5], as specified by `/etc/systemd/system/kxlogger.service`.
This service runs `loggr.q`.

It listens on 127.0.0.1:5202 – i.e. will accept internal connections only. 

It writes to event logs in `/home/logger/logs`. The log files are named `YYYY.MM-nnnnn.log`, e.g. `2017.12-00000.log`. 
A new log is started each month, and when the current log reaches 10Mb. 


Index tables
------------

The index tables consist of four files: `generalContent`, `pages`, `refContent`, and `refs` in `/home/indy/data`.
They are generated by script `buildr.q` _after_ the HTML site has been pushed to the live server; they are then pushed to the server. 

This is part of the site build process. 

Script `buildr.q` requires [PyQ](http://code.kx.com/q/interfaces/pyq/) and [Beautiful Soup](https://www.crummy.com/software/BeautifulSoup/) to be installed. 


Apache configuration
--------------------

Here are the reverse-proxy directives in the virtual host specification for code.kx.com:

    # Search Engine for /search?query=
    # Reverse proxy only
    ProxyRequests Off
    # Pass Host to worker process
    ProxyPreserveHost On
    ProxyPass        /search http://127.0.0.1:5022
    ProxyPassReverse /search http://127.0.0.1:5022


To do
-----

- [x] Custom search for `*`
- [x] Custom search for `?`
- [x] Unescape `><`
- [ ] Variant: for `/search?query=xxx&fmt=ul` – return results as HTML `ul` element, not complete HTML document
- [ ] Variant: Search box from `theme.js` to make Ajax call with `fmt=ul` and display results in MkDocs search results container 


Bibliography
------------

[1]: https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-14-04 "How To Set Up a Firewall with UFW on Ubuntu 14.04"
[2]: https://www.digitalocean.com/community/tutorials/ufw-essentials-common-firewall-rules-and-commands "UFW Essentials: Common Firewall Rules and Commands"
[3]: https://www.digitalocean.com/community/tutorials/how-to-use-apache-as-a-reverse-proxy-with-mod_proxy-on-ubuntu-16-04 "How To Use Apache as a Reverse Proxy with mod_proxy on Ubuntu 16.04"
[4]: https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-16-04 "How To Install Linux, Apache, MySQL, PHP (LAMP) stack on Ubuntu 16.04"
[5]: https://cloudsupport.digitalocean.com/s/#none|ka21N000000Cp7aQAC "How To Use Systemctl to Manage Systemd Services and Units"