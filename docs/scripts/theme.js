/*
 * Custom script for code.kx.com/q 
 * Author: stephen@kx.com
 * Version: 2018.01.17
 * https://gist.github.com/wpscholar/4637176#file-jquery-external-links-new-window-js-L4
 * Open all external links in a new window
 */
$(function() {
    $('a').not('[href*="mailto:"]').each(function () {
		var isInternalLink = new RegExp('/' + window.location.host + '/');
		if ( ! isInternalLink.test(this.href) ) {
			$(this).attr('target', '_blank');
		}
	});
	// Custom Search box
	// copy of HTML generated by native Search plugin 
	var html=`
    <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>

    <div class="md-search" data-md-component="search" role="dialog">
      <label class="md-search__overlay" for="search"></label>
      <div class="md-search__inner">
        <form class="md-search__form" id="kx-search-form" name="search">
          <input type="text" class="md-search__input" id="kx-search-query" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
          <label class="md-icon md-search__icon" for="search"></label>
          <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
        </form>
        <div class="md-search__output">
          <div class="md-search__scrollwrap" data-md-scrollfix>
            <div class="md-search-result" data-md-component="result">
              <div class="md-search-result__meta">
                Type a query and hit Enter
              </div>
              <div class="md-search-result__list"/>
            </div>
          </div>
        </div>
      </div>
    </div>
	`;
	$("div.md-flex div").last().append(html);
	// var serviceRoot = "http://139.59.172.244"; // search engine on DigitalOcean VPS
	// var serviceRoot = window.location.host; // queries revert to originating site for redirection by reverse proxy
	var serviceRoot = 'https://code.kx.com/q/search'; // >>> reverse-proxy directive on Apache httpd
	var srchHandler =function( evt ) {
		// console.log(evt.which);
		if( evt.which===13 ) {
			var url = serviceRoot + "?query=" + encodeURIComponent($("#kx-search-query").val());
			console.log(url);
			window.location = url;
/*          // This query might be executed from a page called by HTTPS, so url below can only be an HTTPS call
			$.get(url, function( data ) {
				alert( 'ping!' );
				console.log( data );
				$( ".md-search-result__list" ).html( data );
			});
*/			return false;
		};
	};
	$("#kx-search-form").keypress(srchHandler);
});
